trigger:
- master
- patch_branch

variables:
- group: DevOps Access Keys
- name: repo
  value: tip

stages:

#####################################
# Linux Stages - Microsoft Hosted VMs
#####################################

  ### Linux Build Stage ###
- stage: linux_build_stage
  displayName: 'Building package on Ubuntu-16.04'
  jobs:
  - job: buildRepo
    displayName: 'Compile Package'
    timeoutInMinutes: 150
    pool:
      vmImage: 'ubuntu-16.04'
    steps:
    # Manually adding conda to the PATH is a step required by Microsoft
    - bash: echo "##vso[task.prependpath]$CONDA/bin"
      displayName: 'Add conda to PATH'
    - task: CondaEnvironment@0
      inputs:
        environmentName: 'Build'
        packageSpecs: 'python=2.7'
    - bash: |
        conda install --yes --quiet -c conda-forge/label/cf201901 -c fermi fermi-repoman scons swig
        conda install --yes --quiet --only-deps -c conda-forge/label/cf201901 -c fermi fermitools
      displayName: 'Setup Build environment'
    - bash: |
        repoman --remote-base https://github.com/fermi-lat checkout --force --develop ScienceTools conda
        rm -rf tip
        git clone https://github.com/fermi-lat/tip
      displayName: 'Clone Repos'
    - bash: |
        mkdir -p ${CONDA_PREFIX}/include/fftw
        ln -s ${CONDA_PREFIX}/include/fftw3.* ${CONDA_PREFIX}/include/fftw
      displayName: 'FFTW relinking'
    - bash: scons -C ScienceTools --site-dir=../SConsShared/site_scons --with-cc=/usr/bin/gcc --with-cxx=/usr/bin/g++ --ccflags="-O2" --cxxflags="-O2 -std=c++11" --conda=$CONDA_PREFIX tip
      displayName: 'Compile Package'

- stage: pipeline_launch_stage
  displayName: 'Launch Fermitools CI Pipeline'
  condition: succeeded('linux_build_stage')
  jobs:
  - job: 
    variables:
      - name: version
        value: 
      - name: revision
        value:
      - name: patch
        value:
      - name: commit
        value:
      - name: author
        value:
      - name: message
        value:
    steps:
    - bash: |
        cd ../
        git clone https://github.com/fermi-lat/fermitools-conda
      displayName: 'Clone repo'
    - bash: |
        echo "##vso[task.setvariable variable=commit]$(git log -1 | head -1 | tr -d '\n')"
        echo "##vso[task.setvariable variable=author]$(git log -1 | head -2 | tail -1 | tr -d '\n')"
        echo "##vso[task.setvariable variable=message]$(git log -1 | tail -1 | awk '{$1=$1};1' | tr -d '\n')"
      displayName: 'Extract repository metadata'
    - bash: |
        cd ../fermitools-conda
        echo "##vso[task.setvariable variable=version]$(grep -i 'set version' meta.yaml | awk '{ print $5}' | sed 's/"//g' | cut -d "." -f 1)"
        echo "##vso[task.setvariable variable=revision]$(grep -i 'set version' meta.yaml | awk '{ print $5}' | sed 's/"//g' | cut -d "." -f 2)"
        echo "##vso[task.setvariable variable=patch]$(grep -i 'set version' meta.yaml | awk '{ print $5}' | sed 's/"//g' | cut -d "." -f 3)"
      displayName: 'Extract version information'
    - bash: |
        cd ../fermitools-conda
        echo Patch is $(patch)
        echo "##vso[task.setvariable variable=patch]$(expr $(patch) + 1)"
      displayName: 'Iterate Patch Number'
    - bash: |
        cd ../fermitools-conda
        echo Patch is $(patch)
        grep -i 'set version' meta.yaml | awk '{ gsub($5,"\"$(version).$(revision).$(patch)\"",$5); print $5}'
      displayName: 'Update Patch Number in Fermitools-Conda meta.yaml'
    - bash: |
        echo Commit is $(commit)
        echo Author is $(author)
        echo Message is $(message)
        git config --global credential.helper store
        echo https://$(Github-Access-Token):x-oauth-basic@github.com>>~/.git-credentials
        git commit -m "Patch iteration triggered by $(repo) repository." -m "Trigger: $(commit) \n Author: $(author) \n Message: $(message)" meta.yaml
        git push